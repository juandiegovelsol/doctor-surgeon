<!DOCTYPE html>
<html>
  <head>
    <title>Super Tick-Tac-Toe</title>
    <style>
      .super-grid {
        display: grid;
        grid-template-columns: repeat(3, 150px);
        gap: 10px;
      }
      .super-cell {
        position: relative;
        border: 2px solid black;
      }
      .sub-grid {
        display: grid;
        grid-template-columns: repeat(3, 100%); /* Ensure sub-grid fits */
        aspect-ratio: 1 / 1; /* Maintain square aspect ratio */
      }
      .cell {
        width: 100%;
        height: 100%;
        border: 1px solid lightgray;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        cursor: pointer;
      }
      .cell:hover {
        background-color: #f0f0f0;
      }
      .small-winner {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 60px;
        background-color: rgba(255, 255, 255, 0.8);
        pointer-events: none;
      }
      .super-cell.disabled {
        pointer-events: none;
        opacity: 0.6;
      }
      body {
        font-family: sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background-color: #f4f4f4;
      }
      .container {
        text-align: center;
      }
      #message {
        margin-top: 20px;
        font-size: 18px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Super Tick-Tac-Toe</h1>
      <div class="super-grid" id="superGrid">
        <!-- Super grid will be generated by JavaScript -->
      </div>
      <p id="message">Current Player: X</p>
    </div>

    <script>
      const superGrid = document.getElementById("superGrid");
      const message = document.getElementById("message");
      let currentPlayer = "X";
      let smallBoardStates = Array(9)
        .fill(null)
        .map(() => Array(9).fill(null));
      let smallBoardWinners = Array(9).fill(null);
      let mainBoardState = Array(9).fill(null);
      let gameActive = true;
      let activeSuperGrid = null; // Index of the currently active super grid

      function createBoard() {
        for (let i = 0; i < 9; i++) {
          const superCell = document.createElement("div");
          superCell.classList.add("super-cell");
          superCell.dataset.superIndex = i;

          const subGrid = document.createElement("div");
          subGrid.classList.add("sub-grid");
          subGrid.dataset.gridIndex = i;

          for (let j = 0; j < 9; j++) {
            const cell = document.createElement("div");
            cell.classList.add("cell");
            cell.dataset.cellIndex = j;
            cell.addEventListener("click", () => handleCellClick(i, j));
            subGrid.appendChild(cell);
          }
          superCell.appendChild(subGrid);
          superGrid.appendChild(superCell);
        }
      }

      function handleCellClick(superIndex, cellIndex) {
        if (
          !gameActive ||
          smallBoardWinners[superIndex] ||
          smallBoardStates[superIndex][cellIndex]
        ) {
          return;
        }

        if (activeSuperGrid !== null && activeSuperGrid !== superIndex) {
          return; // Not the active super grid
        }

        smallBoardStates[superIndex][cellIndex] = currentPlayer;
        const cell = superGrid.children[superIndex].querySelector(
          `.sub-grid .cell[data-cell-index="${cellIndex}"]`
        );
        cell.textContent = currentPlayer;

        const smallWinner = checkWinner(smallBoardStates[superIndex]);
        if (smallWinner) {
          smallBoardWinners[superIndex] = smallWinner;
          const superCellElement = superGrid.children[superIndex];
          const winnerDisplay = document.createElement("div");
          winnerDisplay.classList.add("small-winner");
          winnerDisplay.textContent = smallWinner;
          superCellElement.appendChild(winnerDisplay);
          mainBoardState[superIndex] = smallWinner;
          const mainWinner = checkWinner(mainBoardState);
          if (mainWinner) {
            message.textContent = `Player ${mainWinner} wins the game!`;
            gameActive = false;
            return;
          }
        } else if (smallBoardStates[superIndex].every((c) => c)) {
          smallBoardWinners[superIndex] = "Draw";
          mainBoardState[superIndex] = "Draw";
        }

        // Determine the next active super grid
        activeSuperGrid =
          smallBoardWinners[cellIndex] !== null ? null : cellIndex;

        // Disable/enable super grids based on the active one
        updateSuperGridStates();

        currentPlayer = currentPlayer === "X" ? "O" : "X";
        message.textContent = `Current Player: ${currentPlayer}`;
      }

      function updateSuperGridStates() {
        for (let i = 0; i < 9; i++) {
          const superCell = superGrid.children[i];
          superCell.classList.remove("disabled");
          if (smallBoardWinners[i] !== null) {
            superCell.classList.add("disabled");
          } else if (activeSuperGrid !== null && i !== activeSuperGrid) {
            superCell.classList.add("disabled");
          }
        }
      }

      function checkWinner(board) {
        const lines = [
          [0, 1, 2],
          [3, 4, 5],
          [6, 7, 8],
          [0, 3, 6],
          [1, 4, 7],
          [2, 5, 8],
          [0, 4, 8],
          [2, 4, 6],
        ];
        for (let line of lines) {
          const [a, b, c] = line;
          if (board[a] && board[a] === board[b] && board[a] === board[c]) {
            return board[a];
          }
        }
        return null;
      }

      createBoard();
    </script>
  </body>
</html>
